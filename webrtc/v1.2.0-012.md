# sctp

和tcp/udp类似，sctp是第三种传输层的协议

在webrtc蓝图中，承载datachanne数据的传输

下面一步步分析一下这个sctp的实现，原因是这个Go版本实现的很简单，
其次想看下除了tcp/udp，sctp是如何玩的。

## 目录分析

sctp一个传输层协议，说白了也是传一个sctp报文，从长远来看就是传报文流，

stream.go 抓哟定义了流信息，packet.go定义了报文，
其他都是辅助完成流传输的：

- association
- chunk是分块传输
- error是对传输过程中各种异常的定义
- param定义了传输过程中各种参数
- payload_queue 定义了流中包的顺序处理
- reassembly_queue 定义了重整序的机制

## 分析对外暴露的结构

主要是通过stream对外暴露的一些字段结构

Stream主要对外暴露功能：

- 读/写
- 设置默认负载协议类型
- 关闭

Stream提供了两种读，也提供了两种写：

Read()读不关心负载的协议类型，ReadSCTP会返回负载的协议类型。
读就是从重整序队列reassemblyQueue中取一个数据。

Write()以默认的负载类型来写数据，默认的负载类型就是用接口设置的;
WriteSCTP以指定的负载类型来写数据。
写的流程是先将要写的数据进行切片，这点和rtp没什么区别，
之后调用Stream.association来进行发送(这点后面再具体分析)

Close()纯粹即使释放资源

一个Association表示一个sctp连接，里面可能有多个流,所以这个结构是最顶层的。
Association提供了2个构造函数，一个是创建服务端的ass，一个是创建客户端的ass。

构造函数逻辑：

- 初始化一个Association对象
- 起个协程进行循环读
  - 创建一个8k字节的缓冲来接收从net.Conn中接收的数据
  - 如果这个net.Conn断开了连接，就释放Associatin
  - 之后调用handleInbound来处理读到的数据
- 等到握手做完后，返回构造出的对象

客户端对象比服务端对象多了一个init()初始化的过程

下面是init()初始化中的流程：额外通过net.Conn发送一个包，并状态更新为"等待cookie"

现在分析的函数都已经涉及到了sctp包，那就先分析packet.go

## sctp包结构分析

     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                        Common Header                          |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                          Chunk #1                             |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                           ...                                 |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                          Chunk #n                             |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

common header 的结构：

     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |     Source Port Number        |     Destination Port Number   |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                      Verification Tag                         |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                           Checksum                            |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

源端口，sctp的发送端口。接收端可通过这个发送端口和可能有源ip确定这个包属于谁。
目的端口，sctp包要发到哪儿。
验证tag，接收方会利用这个来校验包。

chunk 的描述：

     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |   Chunk Type  | Chunk  Flags  |        Chunk Length           |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    \                                                               \
    /                          Chunk Value                          /
    \                                                               \
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

chunk value的组成：

     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |          Parameter Type       |       Parameter Length        |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    \                                                               \
    /                       Parameter Value                         /
    \                                                               \
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

chunk data 部分，也就是chunk的payload：

     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |   Type = 0    | Reserved|U|B|E|    Length                     |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                              TSN                              |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |      Stream Identifier S      |   Stream Sequence Number n    |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                  Payload Protocol Identifier                  |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    \                                                               \
    /                 User Data (seq n of Stream S)                 /
    \                                                               \
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

两个sctp建立连接时，需要发送一个INIT chunk，格式如下：

     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |   Type = 1    |  Chunk Flags  |      Chunk Length             |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                         Initiate Tag                          |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |           Advertised Receiver Window Credit (a_rwnd)          |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |  Number of Outbound Streams   |  Number of Inbound Streams    |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                          Initial TSN                          |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    \                                                               \
    /              Optional/Variable-Length Parameters              /
    \                                                               \
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

INIT chunk中最后可选的可变长度的参数格式：

ipv4版本

     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |        Type = 5               |      Length = 8               |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                        IPv4 Address                           |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

ipv6版本

     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |            Type = 6           |          Length = 20          |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                                                               |
    |                         IPv6 Address                          |
    |                                                               |
    |                                                               |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

好吧，不再贴了，难怪sctp不如tcp/udp流行了，一个rfc就这么复杂，
初始化阶段的每个请求和响应都定义成不同格式，实在是非常复杂。

下面直接上源码:

sctp对外提供的接口暴露中，都是字节流，报文packet定义成内部结构，不对外暴露。

    type packet struct {
      sourcePort      uint16
      destinationPort uint16
      verificationTag uint32
      chunks          []chunk
    }

接下来看下packet和字符串之间的序列化和反序列化

unmarshal反序列化，将字符串转成sctp包:

- 读前8个字节(源端口/目的端口/校验tag)
- 根据rfc格式，偏移12字节，取接下来的chunk
- 根据chunk type来决定用哪种方式解析剩下的数据

chunk type 占一个字节。

    ID Value    Chunk Type
    -----       ----------
    0          - Payload Data (DATA)
    1          - Initiation (INIT)
    2          - Initiation Acknowledgement (INIT ACK)
    3          - Selective Acknowledgement (SACK)
    4          - Heartbeat Request (HEARTBEAT)
    5          - Heartbeat Acknowledgement (HEARTBEAT ACK)
    6          - Abort (ABORT)
    7          - Shutdown (SHUTDOWN)
    8          - Shutdown Acknowledgement (SHUTDOWN ACK)
    9          - Operation Error (ERROR)
    10         - State Cookie (COOKIE ECHO)
    11         - Cookie Acknowledgement (COOKIE ACK)
    12         - Reserved for Explicit Congestion Notification Echo (ECNE)
    13         - Reserved for Congestion Window Reduced (CWR)
    14         - Shutdown Complete (SHUTDOWN COMPLETE)
    15 to 255  - 暂不使用，等后续标准的扩展
