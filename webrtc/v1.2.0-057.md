# ice接口之RTCIceCandidate接口

## 功能和idl分析

这个结构表示的是一个具体的ice候选对象。
不止核心的属性(candidate/sdpMid/sdpMLineIndex/usernameFragment),
其他的属性都是通过candidateInitDict结构来传递的，为啥，统一。

rfc[5245](https://tools.ietf.org/html/rfc5245#section-15)详细描述了sdp中的ice语法，
本文后面会进一步介绍，所以前面就不过多介绍。急性子可看4.8.1.1

    interface RTCIceCandidate {
      constructor(optional RTCIceCandidateInit candidateInitDict = {});
      readonly attribute DOMString candidate;
      readonly attribute DOMString? sdpMid;
      readonly attribute unsigned short? sdpMLineIndex;
      readonly attribute DOMString? foundation;
      readonly attribute RTCIceComponent? component;
      readonly attribute unsigned long? priority;
      readonly attribute DOMString? address;
      readonly attribute RTCIceProtocol? protocol;
      readonly attribute unsigned short? port;
      readonly attribute RTCIceCandidateType? type;
      readonly attribute RTCIceTcpCandidateType? tcpType;
      readonly attribute DOMString? relatedAddress;
      readonly attribute unsigned short? relatedPort;
      readonly attribute DOMString? usernameFragment;
      RTCIceCandidateInit toJSON();
    };

按照分析顺序，这是第二个自带构造的结构，构造参数是可选的Init，
这点上和其他结构是统一的。

出构造外，唯一的方法是转json的方法。剩下的都是要暴露的属性。
这些属性基本囊括了sdp中所有ice相关的字段。

## 构造 constructor

调用逻辑如下：

- 如果入参candidateInitDict中sdpMid/sdpMLineIndex都是null，抛出一个TypeError的错误
- 返回___createing an RTCIceCandidate___的结果

___creating an RTCIceCandidate___的具体步骤如下：

- 构造agiel新的RTCIceCandidate对象，赋值给iceCandidate
- 将iceCandidate的下列内部状态全部初始化为null
  - foundation
  - componnent
  - priority
  - address
  - protocol
  - port
  - type
  - tcpType
  - relatedAddress
  - relatedPort
- 将下列内部状态初始化为入参candidateInitDict的同名参数
  - candidate
  - sdpMid
  - sdpMLineIndex
  - usernameFragment
- 临时变量candidate = candidateInitDict.candidate,如果candidate非空，执行如下逻辑：
  - 用___candidate-attribute___语法解析candidate
  - 如果解析失败，退出
  - 解析的结果中，和iceCandidate结构对应的值，如果是无效的，退出
  - 将解析的结果赋值给iceCandidate中的各个内部状态
- 返回iceCandidate

整个构造就是解析入参并赋值。

这里的构造只是简单解析和类型检查，进一步值在上下文中是否有效，
还得看连接对象的addIceCandidate()。

为了最大限度的向后兼容，所有解析错误都被忽略了。这种情况下，
candidate属性 = candidateInitDict.candidate字符串，其他属性都是null。
